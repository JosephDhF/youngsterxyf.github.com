<!DOCTYPE html>
<html lang="zh">
<head>

        <title>Yii源码阅读笔记 - 错误/异常管理</title>
        <meta charset="utf-8" />
        <link href="http://youngsterxyf.github.io/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="黑·白 Full Atom Feed" />
        <link href="http://youngsterxyf.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="黑·白 Full RSS Feed" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="../../../../theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/style.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/pygment.css" />
        <link rel="stylesheet" type="text/css" href="../../../../theme/SentyZHAO/SentyZHAO.css" />

        <script src="../../../../theme/js/libs/jquery-1.9.1.min.js"></script>
        <script src="../../../../theme/js/libs/modernizr-2.6.2.min.js"></script>
            <script>
              var _hmt = _hmt || [];
              (function() {
                var hm = document.createElement("script");
                hm.src = "//hm.baidu.com/hm.js?5c5d8c3fe75afeff117777b9236b96ec";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
              })();
            </script>
</head>

<body id="index" class="home">
    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1 style='font-family: "SentyZHAO";'><a href="../../../..">黑·白 <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>

              <ul class="columns" style='font-family: "SentyZHAO";'>
                <li><a href="../../../..">主 页</a></li>

                <li><a href="/archives.html">归 档</a></li>
                <li><a href="/tags.html">标 签</a></li>
                <li><a href="/pages/tools.html">工具集</a></li>
                <li><a href="/pages/links.html">链 接</a></li>
                <li><a href="/pages/tech-share.html">技术分享</a></li>
                <li><a href="/pages/aboutme.html">关于我</a></li>
                <li><a href="/feeds/rss.xml">RSS</a></li>

              </ul>
            </div>

<section id="content" class="body">
   <div class="row">
        <div class="columns">
            <header>
              <h2 class="entry-title">
                <a href="../../../../2015/09/14/read-yii-code-10/" rel="bookmark" title="Permalink to Yii源码阅读笔记 - 错误/异常管理">Yii源码阅读笔记 - 错误/异常管理</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2015-09-14T00:00:00+08:00">
                2015-09-14 一
              </abbr>
              <address class="vcard author">
                By <a class="url fn" href="../../../../author/youngsterxyf.html">youngsterxyf</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <h3>概述</h3>
<p>PHP区分“错误”（Error）和“异常”（Exception）。“错误”通常是由PHP内部函数抛出，表示运行时问题，当然也可以通过函数trigger_error或user_error抛出一个用户级别的error/warning/notice信息。但在引入面向对象之后，相比使用trigger_error抛出错误，使用throw抛出异常更常用。</p>
<p>对于“错误”，PHP允许配置报告哪些级别/类型错误、是否（向用户）展示错误、是否对错误记录日志、错误日志记到哪，分别对应php.ini中的配置项：error_reporting、display_errors、log_errors、error_log。详细信息见<a href="http://php.net/manual/zh/language.errors.basics.php">这里</a>。</p>
<p>对于应用程序内层调用抛出的“异常”，一般可以在外层中使用try...catch来捕获并自定义处理过程。但对于“错误”（PHP运行时抛出或者应用程序使用trigger_error抛出的）或者对于-无法使用try...catch来捕获可能的异常/为了做到即使忘记捕获的异常也能得到自定义处理-的情况，该怎么办？对此，PHP提供了函数<code>set_error_handler</code>和<code>set_exception_handler</code>来注册错误/异常自定义处理过程。如果在程序的执行流中先后多次调用了<code>set_error_handler</code>或<code>set_exception_handler</code>，后一次注册的处理过程会覆盖前一次的，但可以通过函数<code>restore_error_handler</code>或<code>restore_exception_handler</code>来恢复前一次注册的异常处理过程。</p>
<p><em>之所以写这篇文章，是因为最近在工作中犯了一个低级错误：应用程序中有个API对于不合法的请求参数直接抛出异常（<code>throw new Exception("xxx")</code>），却忘了try...catch捕捉，导致异常被Yii框架（我们的应用基于Yii开发）通过set_exception_handler注册的方法处理 - 响应500，之后这个API被一个扫描器拼命扫，导致出现500多的响应，触发了告警。</em></p>
<h3>分析</h3>
<p>我们来看看Yii框架在哪个地方注册错误/异常处理过程？处理过程是什么样的？</p>
<p>Yii框架在请求处理初始化过程中，在<code>CApplication</code>类（见文件<code>base/CApplication.php</code>）的构造方法中调用了：</p>
<div class="highlight"><pre><span class="x">$this-&gt;initSystemHandlers();</span>
</pre></div>


<p><code>initSystemHandlers</code>的实现如下：</p>
<div class="highlight"><pre><span class="x">/**</span>
<span class="x"> * Initializes the class autoloader and error handlers.</span>
<span class="x"> */</span>
<span class="x">protected function initSystemHandlers()</span>
<span class="x">{</span>
<span class="x">    // 注：如果不想使用Yii框架注册的handleException，可以在初始化应用实例之前，定义常量YII_ENABLE_EXCEPTION_HANDLER值为false</span>
<span class="x">    if(YII_ENABLE_EXCEPTION_HANDLER)</span>
<span class="x">        set_exception_handler(array($this,&#39;handleException&#39;));</span>
<span class="x">    // 注：YII_ENABLE_ERROR_HANDLER也是如此</span>
<span class="x">    if(YII_ENABLE_ERROR_HANDLER)</span>
<span class="x">        set_error_handler(array($this,&#39;handleError&#39;),error_reporting());</span>
<span class="x">}</span>
</pre></div>


<p>其中注册的方法<code>handleException</code>和<code>handleError</code>实现分别如下：</p>
<div class="highlight"><pre><span class="x">public function handleException($exception)</span>
<span class="x">{</span>
<span class="x">    // disable error capturing to avoid recursive errors</span>
<span class="x">    // 这句注释是啥意思？</span>
<span class="x">    restore_error_handler();</span>
<span class="x">    restore_exception_handler();</span>

<span class="x">    // 生成并记录日志信息</span>
<span class="x">    $category=&#39;exception.&#39;.get_class($exception);</span>
<span class="x">    if($exception instanceof CHttpException)</span>
<span class="x">        $category.=&#39;.&#39;.$exception-&gt;statusCode;</span>
<span class="x">    // php &lt;5.2 doesn&#39;t support string conversion auto-magically</span>
<span class="x">    $message=$exception-&gt;__toString();</span>
<span class="x">    if(isset($_SERVER[&#39;REQUEST_URI&#39;]))</span>
<span class="x">        $message.=&quot;\nREQUEST_URI=&quot;.$_SERVER[&#39;REQUEST_URI&#39;];</span>
<span class="x">    if(isset($_SERVER[&#39;HTTP_REFERER&#39;]))</span>
<span class="x">        $message.=&quot;\nHTTP_REFERER=&quot;.$_SERVER[&#39;HTTP_REFERER&#39;];</span>
<span class="x">    $message.=&quot;\n---&quot;;</span>
<span class="x">    Yii::log($message,CLogger::LEVEL_ERROR,$category);</span>

<span class="x">    try</span>
<span class="x">    {</span>
<span class="x">        // 将异常封装成事件，并触发事件，从而触发监听该事件的处理过程</span>
<span class="x">        $event=new CExceptionEvent($this,$exception);</span>
<span class="x">        $this-&gt;onException($event);</span>
<span class="x">        // 如果事件并没有被处理（即没有监听该事件的处理过程）或者所有处理过程都没有将事件的handled属性置为true，则还得自己处理一下</span>
<span class="x">        if(!$event-&gt;handled)</span>
<span class="x">        {</span>
<span class="x">            // try an error handler</span>
<span class="x">            if(($handler=$this-&gt;getErrorHandler())!==null)</span>
<span class="x">                $handler-&gt;handle($event);</span>
<span class="x">            else</span>
<span class="x">                $this-&gt;displayException($exception);</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">    catch(Exception $e)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;displayException($e);</span>
<span class="x">    }</span>

<span class="x">    try</span>
<span class="x">    {</span>
<span class="x">        // 尝试触发onEndRequest事件</span>
<span class="x">        $this-&gt;end(1);</span>
<span class="x">    }</span>
<span class="x">    catch(Exception $e)</span>
<span class="x">    {</span>
<span class="x">        // use the most primitive way to log error</span>
<span class="x">        $msg = get_class($e).&#39;: &#39;.$e-&gt;getMessage().&#39; (&#39;.$e-&gt;getFile().&#39;:&#39;.$e-&gt;getLine().&quot;)\n&quot;;</span>
<span class="x">        $msg .= $e-&gt;getTraceAsString().&quot;\n&quot;;</span>
<span class="x">        $msg .= &quot;Previous exception:\n&quot;;</span>
<span class="x">        $msg .= get_class($exception).&#39;: &#39;.$exception-&gt;getMessage().&#39; (&#39;.$exception-&gt;getFile().&#39;:&#39;.$exception-&gt;getLine().&quot;)\n&quot;;</span>
<span class="x">        $msg .= $exception-&gt;getTraceAsString().&quot;\n&quot;;</span>
<span class="x">        $msg .= &#39;$_SERVER=&#39;.var_export($_SERVER,true);</span>
<span class="x">        error_log($msg);</span>
<span class="x">        exit(1);</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<div class="highlight"><pre><span class="x">public function handleError($code,$message,$file,$line)</span>
<span class="x">{</span>
<span class="x">    if($code &amp; error_reporting())</span>
<span class="x">    {</span>
<span class="x">        // disable error capturing to avoid recursive errors</span>
<span class="x">        restore_error_handler();</span>
<span class="x">        restore_exception_handler();</span>

<span class="x">        // 生成并记录日志信息</span>
<span class="x">        $log=&quot;$message ($file:$line)\nStack trace:\n&quot;;</span>

<span class="x">        // debug_backtrace() 产生一条 PHP 的回溯跟踪</span>
<span class="x">        $trace=debug_backtrace();</span>
<span class="x">        // skip the first 3 stacks as they do not tell the error position</span>
<span class="x">        if(count($trace)&gt;3)</span>
<span class="x">            $trace=array_slice($trace,3);</span>
<span class="x">        foreach($trace as $i=&gt;$t)</span>
<span class="x">        {</span>
<span class="x">            if(!isset($t[&#39;file&#39;]))</span>
<span class="x">                $t[&#39;file&#39;]=&#39;unknown&#39;;</span>
<span class="x">            if(!isset($t[&#39;line&#39;]))</span>
<span class="x">                $t[&#39;line&#39;]=0;</span>
<span class="x">            if(!isset($t[&#39;function&#39;]))</span>
<span class="x">                $t[&#39;function&#39;]=&#39;unknown&#39;;</span>
<span class="x">            $log.=&quot;#$i {$t[&#39;file&#39;]}({$t[&#39;line&#39;]}): &quot;;</span>
<span class="x">            if(isset($t[&#39;object&#39;]) &amp;&amp; is_object($t[&#39;object&#39;]))</span>
<span class="x">                $log.=get_class($t[&#39;object&#39;]).&#39;-&gt;&#39;;</span>
<span class="x">            $log.=&quot;{$t[&#39;function&#39;]}()\n&quot;;</span>
<span class="x">        }</span>
<span class="x">        if(isset($_SERVER[&#39;REQUEST_URI&#39;]))</span>
<span class="x">            $log.=&#39;REQUEST_URI=&#39;.$_SERVER[&#39;REQUEST_URI&#39;];</span>
<span class="x">        Yii::log($log,CLogger::LEVEL_ERROR,&#39;php&#39;);</span>

<span class="x">        try</span>
<span class="x">        {</span>
<span class="x">            // 将错误封装成事件，并触发</span>
<span class="x">            Yii::import(&#39;CErrorEvent&#39;,true);</span>
<span class="x">            $event=new CErrorEvent($this,$code,$message,$file,$line);</span>
<span class="x">            $this-&gt;onError($event);</span>
<span class="x">            // 如果错误事件未被处理</span>
<span class="x">            if(!$event-&gt;handled)</span>
<span class="x">            {</span>
<span class="x">                // try an error handler</span>
<span class="x">                if(($handler=$this-&gt;getErrorHandler())!==null)</span>
<span class="x">                    $handler-&gt;handle($event);</span>
<span class="x">                else</span>
<span class="x">                    $this-&gt;displayError($code,$message,$file,$line);</span>
<span class="x">            }</span>
<span class="x">        }</span>
<span class="x">        catch(Exception $e)</span>
<span class="x">        {</span>
<span class="x">            $this-&gt;displayException($e);</span>
<span class="x">        }</span>

<span class="x">        try</span>
<span class="x">        {</span>
<span class="x">            // 尝试触发onEndRequest事件</span>
<span class="x">            $this-&gt;end(1);</span>
<span class="x">        }</span>
<span class="x">        catch(Exception $e)</span>
<span class="x">        {</span>
<span class="x">            // use the most primitive way to log error</span>
<span class="x">            $msg = get_class($e).&#39;: &#39;.$e-&gt;getMessage().&#39; (&#39;.$e-&gt;getFile().&#39;:&#39;.$e-&gt;getLine().&quot;)\n&quot;;</span>
<span class="x">            $msg .= $e-&gt;getTraceAsString().&quot;\n&quot;;</span>
<span class="x">            $msg .= &quot;Previous error:\n&quot;;</span>
<span class="x">            $msg .= $log.&quot;\n&quot;;</span>
<span class="x">            $msg .= &#39;$_SERVER=&#39;.var_export($_SERVER,true);</span>
<span class="x">            error_log($msg);</span>
<span class="x">            exit(1);</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p>从上面代码可以看到，方法<code>handleException</code>的关键部分为：</p>
<div class="highlight"><pre><span class="x">// 将异常封装成事件，并触发事件，从而触发监听该事件的处理过程</span>
<span class="x">$event=new CExceptionEvent($this,$exception);</span>
<span class="x">$this-&gt;onException($event);</span>
<span class="x">// 如果事件并没有被处理（即没有监听该事件的处理过程）或者所有处理过程都没有将事件的handled属性置为true，则还得自己处理一下</span>
<span class="x">if(!$event-&gt;handled)</span>
<span class="x">{</span>
<span class="x">    // try an error handler</span>
<span class="x">    if(($handler=$this-&gt;getErrorHandler())!==null)</span>
<span class="x">        $handler-&gt;handle($event);</span>
<span class="x">    else</span>
<span class="x">        $this-&gt;displayException($exception);</span>
<span class="x">}</span>
</pre></div>


<p>其中方法<code>onException</code>的实现如下：</p>
<div class="highlight"><pre><span class="x">public function onException($event)</span>
<span class="x">{</span>
<span class="x">    $this-&gt;raiseEvent(&#39;onException&#39;,$event);</span>
<span class="x">}</span>
</pre></div>


<p><code>raiseEvent</code>方法实现如下：</p>
<div class="highlight"><pre><span class="x">public function raiseEvent($name,$event)</span>
<span class="x">{</span>
<span class="x">    // 根据事件名称，如onException，找到注册到该事件的处理过程，逐个触发调用。</span>
<span class="x">    // 所有该事件注册的处理过程存放在$this-&gt;_e[$name]中</span>
<span class="x">    $name=strtolower($name);</span>
<span class="x">    if(isset($this-&gt;_e[$name]))</span>
<span class="x">    {</span>
<span class="x">        foreach($this-&gt;_e[$name] as $handler)</span>
<span class="x">        {</span>
<span class="x">            if(is_string($handler))</span>
<span class="x">                call_user_func($handler,$event);</span>
<span class="x">            elseif(is_callable($handler,true))</span>
<span class="x">            {</span>
<span class="x">                if(is_array($handler))</span>
<span class="x">                {</span>
<span class="x">                    // an array: 0 - object, 1 - method name</span>
<span class="x">                    list($object,$method)=$handler;</span>
<span class="x">                    if(is_string($object))  // static method call</span>
<span class="x">                        call_user_func($handler,$event);</span>
<span class="x">                    elseif(method_exists($object,$method))</span>
<span class="x">                        $object-&gt;$method($event);</span>
<span class="x">                    else</span>
<span class="x">                        throw new CException(Yii::t(&#39;yii&#39;,&#39;Event &quot;{class}.{event}&quot; is attached with an invalid handler &quot;{handler}&quot;.&#39;,</span>
<span class="x">                            array(&#39;{class}&#39;=&gt;get_class($this), &#39;{event}&#39;=&gt;$name, &#39;{handler}&#39;=&gt;$handler[1])));</span>
<span class="x">                }</span>
<span class="x">                else // PHP 5.3: anonymous function</span>
<span class="x">                    call_user_func($handler,$event);</span>
<span class="x">            }</span>
<span class="x">            else</span>
<span class="x">                throw new CException(Yii::t(&#39;yii&#39;,&#39;Event &quot;{class}.{event}&quot; is attached with an invalid handler &quot;{handler}&quot;.&#39;,</span>
<span class="x">                    array(&#39;{class}&#39;=&gt;get_class($this), &#39;{event}&#39;=&gt;$name, &#39;{handler}&#39;=&gt;gettype($handler))));</span>
<span class="x">            // stop further handling if param.handled is set true</span>
<span class="x">            if(($event instanceof CEvent) &amp;&amp; $event-&gt;handled)</span>
<span class="x">                return;</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">    elseif(YII_DEBUG &amp;&amp; !$this-&gt;hasEvent($name))</span>
<span class="x">        throw new CException(Yii::t(&#39;yii&#39;,&#39;Event &quot;{class}.{event}&quot; is not defined.&#39;,</span>
<span class="x">            array(&#39;{class}&#39;=&gt;get_class($this), &#39;{event}&#39;=&gt;$name)));</span>
<span class="x">}</span>
</pre></div>


<p>那么是如何注册事件的处理过程的呢？</p>
<p>在类<code>CComponent</code>（见文件<code>base/CComponent.php</code>，<code>CApplication</code>类继承间接继承自该类）中定义了一对方法：<code>attachEventHandler</code>（将处理过程绑定到某事件）和<code>detachEventHandler</code>（将处理过程从事件解绑）。</p>
<p>方法<code>attachEventHandler</code>的实现如下：</p>
<div class="highlight"><pre><span class="x">public function attachEventHandler($name,$handler)</span>
<span class="x">{</span>
<span class="x">    $this-&gt;getEventHandlers($name)-&gt;add($handler);</span>
<span class="x">}</span>
</pre></div>


<p>其中<code>getEventHandlers</code>实现如下：</p>
<div class="highlight"><pre><span class="x">public function getEventHandlers($name)</span>
<span class="x">{</span>
<span class="x">    // 可以关注一下方法hasEvent</span>
<span class="x">    // 检查是否存在$name对应的事件</span>
<span class="x">    if($this-&gt;hasEvent($name))</span>
<span class="x">    {</span>
<span class="x">        $name=strtolower($name);</span>
<span class="x">        if(!isset($this-&gt;_e[$name]))</span>
<span class="x">            $this-&gt;_e[$name]=new CList;</span>
<span class="x">        // 返回对应事件的处理过程列表</span>
<span class="x">        return $this-&gt;_e[$name];</span>
<span class="x">    }</span>
<span class="x">    else</span>
<span class="x">        throw new CException(Yii::t(&#39;yii&#39;,&#39;Event &quot;{class}.{event}&quot; is not defined.&#39;,</span>
<span class="x">            array(&#39;{class}&#39;=&gt;get_class($this), &#39;{event}&#39;=&gt;$name)));</span>
<span class="x">}</span>
</pre></div>


<p>回到“方法<code>handleException</code>的关键部分”，在事件的handled属性没有置为true的情况下，会调用方法<code>getErrorHandler</code>取到内置的一个处理过程，该方法实现如下：</p>
<div class="highlight"><pre><span class="x">public function getErrorHandler()</span>
<span class="x">{</span>
<span class="x">    // 获取名为errorHandler的组件，该组件默认会在CApplication类的registerCoreComponents方法中注册，</span>
<span class="x">    // 见http://blog.xiayf.cn/2014/11/13/read-yii-code-3/一文的说明</span>
<span class="x">    return $this-&gt;getComponent(&#39;errorHandler&#39;);</span>
<span class="x">}</span>
</pre></div>


<p>名为errorHandler的组件默认为类<code>CErrorHandler</code>（见文件<code>base/CErrorHandler.php</code>），当然也可以配置覆盖默认行为。</p>
<p><code>CErrorHandler</code>类的<code>handle</code>方法实现如下：</p>
<div class="highlight"><pre><span class="x">public function handle($event)</span>
<span class="x">{</span>
<span class="x">    // set event as handled to prevent it from being handled by other event handlers</span>
<span class="x">    $event-&gt;handled=true;</span>

<span class="x">    if($this-&gt;discardOutput)</span>
<span class="x">    {</span>
<span class="x">        $gzHandler=false;</span>
<span class="x">        foreach(ob_list_handlers() as $h)</span>
<span class="x">        {</span>
<span class="x">            if(strpos($h,&#39;gzhandler&#39;)!==false)</span>
<span class="x">                $gzHandler=true;</span>
<span class="x">        }</span>
<span class="x">        // the following manual level counting is to deal with zlib.output_compression set to On</span>
<span class="x">        // for an output buffer created by zlib.output_compression set to On ob_end_clean will fail</span>
<span class="x">        for($level=ob_get_level();$level&gt;0;--$level)</span>
<span class="x">        {</span>
<span class="x">            if(!@ob_end_clean())</span>
<span class="x">                ob_clean();</span>
<span class="x">        }</span>
<span class="x">        // reset headers in case there was an ob_start(&quot;ob_gzhandler&quot;) before</span>
<span class="x">        if($gzHandler &amp;&amp; !headers_sent() &amp;&amp; ob_list_handlers()===array())</span>
<span class="x">        {</span>
<span class="x">            if(function_exists(&#39;header_remove&#39;)) // php &gt;= 5.3</span>
<span class="x">            {</span>
<span class="x">                header_remove(&#39;Vary&#39;);</span>
<span class="x">                header_remove(&#39;Content-Encoding&#39;);</span>
<span class="x">            }</span>
<span class="x">            else</span>
<span class="x">            {</span>
<span class="x">                header(&#39;Vary:&#39;);</span>
<span class="x">                header(&#39;Content-Encoding:&#39;);</span>
<span class="x">            }</span>
<span class="x">        }</span>
<span class="x">    }</span>

<span class="x">    // 异常和错误都可以调用handle方法</span>
<span class="x">    if($event instanceof CExceptionEvent)</span>
<span class="x">        $this-&gt;handleException($event-&gt;exception);</span>
<span class="x">    else // CErrorEvent</span>
<span class="x">        $this-&gt;handleError($event);</span>
<span class="x">}</span>
</pre></div>


<p>其中方法<code>handleException</code>和<code>handleError</code>实现分别如下：</p>
<div class="highlight"><pre><span class="x">protected function handleException($exception)</span>
<span class="x">{</span>
<span class="x">    $app=Yii::app();</span>
<span class="x">    // 如果是Web应用</span>
<span class="x">    if($app instanceof CWebApplication)</span>
<span class="x">    {</span>
<span class="x">        if(($trace=$this-&gt;getExactTrace($exception))===null)</span>
<span class="x">        {</span>
<span class="x">            $fileName=$exception-&gt;getFile();</span>
<span class="x">            $errorLine=$exception-&gt;getLine();</span>
<span class="x">        }</span>
<span class="x">        else</span>
<span class="x">        {</span>
<span class="x">            $fileName=$trace[&#39;file&#39;];</span>
<span class="x">            $errorLine=$trace[&#39;line&#39;];</span>
<span class="x">        }</span>

<span class="x">        $trace = $exception-&gt;getTrace();</span>

<span class="x">        foreach($trace as $i=&gt;$t)</span>
<span class="x">        {</span>
<span class="x">            if(!isset($t[&#39;file&#39;]))</span>
<span class="x">                $trace[$i][&#39;file&#39;]=&#39;unknown&#39;;</span>

<span class="x">            if(!isset($t[&#39;line&#39;]))</span>
<span class="x">                $trace[$i][&#39;line&#39;]=0;</span>

<span class="x">            if(!isset($t[&#39;function&#39;]))</span>
<span class="x">                $trace[$i][&#39;function&#39;]=&#39;unknown&#39;;</span>

<span class="x">            unset($trace[$i][&#39;object&#39;]);</span>
<span class="x">        }</span>

<span class="x">        $this-&gt;_error=$data=array(</span>
<span class="x">            // 如果抛出的异常是CHttpException类型，使用该异常自身的statusCode作为HTTP响应码，否则HTTP响应码为500</span>
<span class="x">            // 所以在有意让Yii框架来处理抛出的异常时，需要明确指定异常的类型！</span>
<span class="x">            &#39;code&#39;=&gt;($exception instanceof CHttpException)?$exception-&gt;statusCode:500,</span>
<span class="x">            &#39;type&#39;=&gt;get_class($exception),</span>
<span class="x">            &#39;errorCode&#39;=&gt;$exception-&gt;getCode(),</span>
<span class="x">            &#39;message&#39;=&gt;$exception-&gt;getMessage(),</span>
<span class="x">            &#39;file&#39;=&gt;$fileName,</span>
<span class="x">            &#39;line&#39;=&gt;$errorLine,</span>
<span class="x">            &#39;trace&#39;=&gt;$exception-&gt;getTraceAsString(),</span>
<span class="x">            &#39;traces&#39;=&gt;$trace,</span>
<span class="x">        );</span>

<span class="x">        if(!headers_sent())</span>
<span class="x">            header(&quot;HTTP/1.0 {$data[&#39;code&#39;]} &quot;.$this-&gt;getHttpHeader($data[&#39;code&#39;], get_class($exception)));</span>

<span class="x">        // 判断异常类型</span>
<span class="x">        // 对于CHttpException，也按照error来处理</span>
<span class="x">        if($exception instanceof CHttpException || !YII_DEBUG)</span>
<span class="x">            $this-&gt;render(&#39;error&#39;,$data);</span>
<span class="x">        else</span>
<span class="x">        {</span>
<span class="x">            if($this-&gt;isAjaxRequest())</span>
<span class="x">                $app-&gt;displayException($exception);</span>
<span class="x">            else</span>
<span class="x">                $this-&gt;render(&#39;exception&#39;,$data);</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">    // 如果是终端应用（console application），则直接展示异常</span>
<span class="x">    else</span>
<span class="x">        $app-&gt;displayException($exception);</span>
<span class="x">}</span>
</pre></div>


<div class="highlight"><pre><span class="x">protected function handleError($event)</span>
<span class="x">{</span>
<span class="x">    $trace=debug_backtrace();</span>
<span class="x">    // skip the first 3 stacks as they do not tell the error position</span>
<span class="x">    if(count($trace)&gt;3)</span>
<span class="x">        $trace=array_slice($trace,3);</span>
<span class="x">    $traceString=&#39;&#39;;</span>
<span class="x">    foreach($trace as $i=&gt;$t)</span>
<span class="x">    {</span>
<span class="x">        if(!isset($t[&#39;file&#39;]))</span>
<span class="x">            $trace[$i][&#39;file&#39;]=&#39;unknown&#39;;</span>

<span class="x">        if(!isset($t[&#39;line&#39;]))</span>
<span class="x">            $trace[$i][&#39;line&#39;]=0;</span>

<span class="x">        if(!isset($t[&#39;function&#39;]))</span>
<span class="x">            $trace[$i][&#39;function&#39;]=&#39;unknown&#39;;</span>

<span class="x">        $traceString.=&quot;#$i {$trace[$i][&#39;file&#39;]}({$trace[$i][&#39;line&#39;]}): &quot;;</span>
<span class="x">        if(isset($t[&#39;object&#39;]) &amp;&amp; is_object($t[&#39;object&#39;]))</span>
<span class="x">            $traceString.=get_class($t[&#39;object&#39;]).&#39;-&gt;&#39;;</span>
<span class="x">        $traceString.=&quot;{$trace[$i][&#39;function&#39;]}()\n&quot;;</span>

<span class="x">        unset($trace[$i][&#39;object&#39;]);</span>
<span class="x">    }</span>

<span class="x">    $app=Yii::app();</span>
<span class="x">    // 如果是Web应用</span>
<span class="x">    if($app instanceof CWebApplication)</span>
<span class="x">    {</span>
<span class="x">        // 判断错误类型</span>
<span class="x">        switch($event-&gt;code)</span>
<span class="x">        {</span>
<span class="x">            case E_WARNING:</span>
<span class="x">                $type = &#39;PHP warning&#39;;</span>
<span class="x">                break;</span>
<span class="x">            case E_NOTICE:</span>
<span class="x">                $type = &#39;PHP notice&#39;;</span>
<span class="x">                break;</span>
<span class="x">            case E_USER_ERROR:</span>
<span class="x">                $type = &#39;User error&#39;;</span>
<span class="x">                break;</span>
<span class="x">            case E_USER_WARNING:</span>
<span class="x">                $type = &#39;User warning&#39;;</span>
<span class="x">                break;</span>
<span class="x">            case E_USER_NOTICE:</span>
<span class="x">                $type = &#39;User notice&#39;;</span>
<span class="x">                break;</span>
<span class="x">            case E_RECOVERABLE_ERROR:</span>
<span class="x">                $type = &#39;Recoverable error&#39;;</span>
<span class="x">                break;</span>
<span class="x">            default:</span>
<span class="x">                $type = &#39;PHP error&#39;;</span>
<span class="x">        }</span>
<span class="x">        // HTTP响应码为500</span>
<span class="x">        $this-&gt;_error=$data=array(</span>
<span class="x">            &#39;code&#39;=&gt;500,</span>
<span class="x">            &#39;type&#39;=&gt;$type,</span>
<span class="x">            &#39;message&#39;=&gt;$event-&gt;message,</span>
<span class="x">            &#39;file&#39;=&gt;$event-&gt;file,</span>
<span class="x">            &#39;line&#39;=&gt;$event-&gt;line,</span>
<span class="x">            &#39;trace&#39;=&gt;$traceString,</span>
<span class="x">            &#39;traces&#39;=&gt;$trace,</span>
<span class="x">        );</span>
<span class="x">        if(!headers_sent())</span>
<span class="x">            header(&quot;HTTP/1.0 500 Internal Server Error&quot;);</span>
<span class="x">        if($this-&gt;isAjaxRequest())</span>
<span class="x">            $app-&gt;displayError($event-&gt;code,$event-&gt;message,$event-&gt;file,$event-&gt;line);</span>
<span class="x">        elseif(YII_DEBUG)</span>
<span class="x">            // 开了debug，则作为exception来处理</span>
<span class="x">            $this-&gt;render(&#39;exception&#39;,$data);</span>
<span class="x">        else</span>
<span class="x">            $this-&gt;render(&#39;error&#39;,$data);</span>
<span class="x">    }</span>
<span class="x">    else</span>
<span class="x">        $app-&gt;displayError($event-&gt;code,$event-&gt;message,$event-&gt;file,$event-&gt;line);</span>
<span class="x">}</span>
</pre></div>


<p>上面的代码最终显示异常/错误信息，是通过方法<code>render</code>、以及应用实例的<code>displayError</code>和<code>displayException</code>方法来完成。</p>
<p><strong>render</strong></p>
<div class="highlight"><pre><span class="x">protected function render($view,$data)</span>
<span class="x">{</span>
<span class="x">    // 注意这个地方，如果配置了errorAction，则可以指定目标controller的某个action来处理错误</span>
<span class="x">    /*</span>
<span class="x">     * 配置方式：</span>
<span class="x">     * &#39;components&#39; =&gt; array(</span>
<span class="x">     *      &#39;errorHandler&#39; =&gt; array(</span>
<span class="x">     *          &#39;errorAction&#39;=&gt;&#39;api/index/error&#39;,</span>
<span class="x">     *     ),</span>
<span class="x">     *     ...</span>
<span class="x">     */</span>
<span class="x">    if($view===&#39;error&#39; &amp;&amp; $this-&gt;errorAction!==null)</span>
<span class="x">        Yii::app()-&gt;runController($this-&gt;errorAction);</span>
<span class="x">    else</span>
<span class="x">    {</span>
<span class="x">        // additional information to be passed to view</span>
<span class="x">        $data[&#39;version&#39;]=$this-&gt;getVersionInfo();</span>
<span class="x">        $data[&#39;time&#39;]=time();</span>
<span class="x">        $data[&#39;admin&#39;]=$this-&gt;adminInfo;</span>

<span class="x">        // 看看下面getViewFile的实现</span>
<span class="x">        include($this-&gt;getViewFile($view,$data[&#39;code&#39;]));</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">protected function getViewFile($view,$code)</span>
<span class="x">{</span>
<span class="x">    $viewPaths=array(</span>
<span class="x">        Yii::app()-&gt;getTheme()===null ? null :  Yii::app()-&gt;getTheme()-&gt;getSystemViewPath(),</span>
<span class="x">        Yii::app() instanceof CWebApplication ? Yii::app()-&gt;getSystemViewPath() : null,</span>
<span class="x">        YII_PATH.DIRECTORY_SEPARATOR.&#39;views&#39;,</span>
<span class="x">    );</span>

<span class="x">    foreach($viewPaths as $i=&gt;$viewPath)</span>
<span class="x">    {</span>
<span class="x">        if($viewPath!==null)</span>
<span class="x">        {</span>
<span class="x">             // 看看下面getViewFileInternal的实现</span>
<span class="x">             $viewFile=$this-&gt;getViewFileInternal($viewPath,$view,$code,$i===2?&#39;en_us&#39;:null);</span>
<span class="x">             if(is_file($viewFile))</span>
<span class="x">                 return $viewFile;</span>
<span class="x">        }</span>
<span class="x">    }</span>
<span class="x">}</span>

<span class="x">protected function getViewFileInternal($viewPath,$view,$code,$srcLanguage=null)</span>
<span class="x">{</span>
<span class="x">    $app=Yii::app();</span>
<span class="x">    if($view===&#39;error&#39;)</span>
<span class="x">    {</span>
<span class="x">        $viewFile=$app-&gt;findLocalizedFile($viewPath.DIRECTORY_SEPARATOR.&quot;error{$code}.php&quot;,$srcLanguage);</span>
<span class="x">        if(!is_file($viewFile))</span>
<span class="x">            $viewFile=$app-&gt;findLocalizedFile($viewPath.DIRECTORY_SEPARATOR.&#39;error.php&#39;,$srcLanguage);</span>
<span class="x">    }</span>
<span class="x">    else</span>
<span class="x">        $viewFile=$viewPath.DIRECTORY_SEPARATOR.&quot;exception.php&quot;;</span>
<span class="x">    return $viewFile;</span>
<span class="x">}</span>
</pre></div>


<p>上面代码的逻辑是 - 对于error类型的信息，Yii会依次在以下目录中寻找名为<code>error{$code}.php</code>文件来展示错误/异常信息：</p>
<ol>
<li>WebRoot/themes/ThemeName/views/system</li>
<li>WebRoot/protected/views/system</li>
<li>yii/framework/views</li>
</ol>
<p>如果没有找到，则以相同的次序在这些目录中查找<code>error.php</code>文件。</p>
<p>对于exception类型信息，则是查找<code>exception.php</code>文件。</p>
<p>所以如果应用开发过程需要定制4xx、5xx的错误页面，可以在<code>WebRoot/protected/views/system</code>或<code>WebRoot/themes/ThemeName/views/system</code>放置对应的错误模板页面。</p>
<p><strong>displayError</strong></p>
<div class="highlight"><pre><span class="x">public function displayError($code,$message,$file,$line)</span>
<span class="x">{</span>
<span class="x">    if(YII_DEBUG)</span>
<span class="x">    {</span>
<span class="x">        echo &quot;&lt;h1&gt;PHP Error [$code]&lt;/h1&gt;\n&quot;;</span>
<span class="x">        echo &quot;&lt;p&gt;$message ($file:$line)&lt;/p&gt;\n&quot;;</span>
<span class="x">        echo &#39;&lt;pre&gt;&#39;;</span>

<span class="x">        $trace=debug_backtrace();</span>
<span class="x">        // skip the first 3 stacks as they do not tell the error position</span>
<span class="x">        if(count($trace)&gt;3)</span>
<span class="x">            $trace=array_slice($trace,3);</span>
<span class="x">        foreach($trace as $i=&gt;$t)</span>
<span class="x">        {</span>
<span class="x">            if(!isset($t[&#39;file&#39;]))</span>
<span class="x">                $t[&#39;file&#39;]=&#39;unknown&#39;;</span>
<span class="x">            if(!isset($t[&#39;line&#39;]))</span>
<span class="x">                $t[&#39;line&#39;]=0;</span>
<span class="x">            if(!isset($t[&#39;function&#39;]))</span>
<span class="x">                $t[&#39;function&#39;]=&#39;unknown&#39;;</span>
<span class="x">            echo &quot;#$i {$t[&#39;file&#39;]}({$t[&#39;line&#39;]}): &quot;;</span>
<span class="x">            if(isset($t[&#39;object&#39;]) &amp;&amp; is_object($t[&#39;object&#39;]))</span>
<span class="x">                echo get_class($t[&#39;object&#39;]).&#39;-&gt;&#39;;</span>
<span class="x">            echo &quot;{$t[&#39;function&#39;]}()\n&quot;;</span>
<span class="x">        }</span>

<span class="x">        echo &#39;&lt;/pre&gt;&#39;;</span>
<span class="x">    }</span>
<span class="x">    else</span>
<span class="x">    {</span>
<span class="x">        echo &quot;&lt;h1&gt;PHP Error [$code]&lt;/h1&gt;\n&quot;;</span>
<span class="x">        echo &quot;&lt;p&gt;$message&lt;/p&gt;\n&quot;;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<p><strong>displayException</strong></p>
<div class="highlight"><pre><span class="x">public function displayException($exception)</span>
<span class="x">{</span>
<span class="x">    if(YII_DEBUG)</span>
<span class="x">    {</span>
<span class="x">        echo &#39;&lt;h1&gt;&#39;.get_class($exception).&quot;&lt;/h1&gt;\n&quot;;</span>
<span class="x">        echo &#39;&lt;p&gt;&#39;.$exception-&gt;getMessage().&#39; (&#39;.$exception-&gt;getFile().&#39;:&#39;.$exception-&gt;getLine().&#39;)&lt;/p&gt;&#39;;</span>
<span class="x">        echo &#39;&lt;pre&gt;&#39;.$exception-&gt;getTraceAsString().&#39;&lt;/pre&gt;&#39;;</span>
<span class="x">    }</span>
<span class="x">    else</span>
<span class="x">    {</span>
<span class="x">        echo &#39;&lt;h1&gt;&#39;.get_class($exception).&quot;&lt;/h1&gt;\n&quot;;</span>
<span class="x">        echo &#39;&lt;p&gt;&#39;.$exception-&gt;getMessage().&#39;&lt;/p&gt;&#39;;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>


<h3>总结</h3>
<p>由上述分析可知，基于Yii框架开发应用时，有以下几点注意事项：</p>
<ul>
<li>可以通过配置组件<code>errorHandler</code>的<code>errorAction</code>属性来定制异常/错误处理过程</li>
<li>可以通过在<code>WebRoot/themes/ThemeName/views/system</code>或<code>WebRoot/protected/views/system</code>放置模板（名为<code>error{$code}.php</code>）来定制错误/异常展示方式</li>
<li>在有意抛出异常由Yii框架捕获时，需明确异常的类型是否应为<code>CHttpException</code>，只有<code>CHttpException</code>实例初始化时指定的code才能成为HTTP响应码</li>
<li>可以对事件<code>onError</code>、<code>onException</code>绑定事件处理过程，进行额外的处理，比如记录错误/异常、触发告警等</li>
</ul>
<h3>参考资料</h3>
<ul>
<li><a href="http://php.net/manual/zh/book.errorfunc.php">PHP手册 - 错误处理和日志记录</a></li>
<li><a href="http://www.yiiframework.com/doc/guide/1.1/en/topics.error">Error Handling</a></li>
<li><a href="/assets/uploads/files/PHP-Debug-Manual-public.pdf">PHP调试技术手册</a></li>
</ul>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "2015/09/14/read-yii-code-10/";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://xiayfblackwhite.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>
        </div><!-- /.twelve.columns -->
 </div><!-- /.row -->
</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">


        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">

                <li><div class="btn primary"><a href="http://github.com/youngsterxyf" target="_blank">Github</a></div></li>

                <li><div class="btn twitter"><a href="https://twitter.com/youngsterxyf" target="_blank">Twitter</a></div></li>

                <li><div class="btn warning"><a href="http://weibo.com/u/1855563263" target="_blank">Weibo</a></div></li>

                <li><div class="btn douban"><a href="http://www.douban.com/people/youngster21/" target="_blank">Douban</a></div></li>



              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'xiayfblackwhite';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="../../../../theme/js/libs/gumby.min.js"></script>
  <script src="../../../../theme/js/plugins.js"></script>
  <script src="../../../../theme/js/main.js"></script>
</body>
</html>